//-------------------------------------------------------------------------------------------------
//
//  FileListView.cpp
//  cmacs
//
//  Created by Todd Vernon on 9/15/23.
//  Copyright Â© 2022 Todd Vernon. All rights reserved.
//
//
//-------------------------------------------------------------------------------------------------




//-------------------------------------------------------------------------------------------------
// FileListView.cpp
//
// Edit View the class that handles display of the edit buffer on the screen.  It handles
// screen sizing and resizing and reframing the visible part of the edit buffer on the
// visible screen.
//
//-------------------------------------------------------------------------------------------------

#include "FileListView.h"

//-------------------------------------------------------------------------------------------------
// FileListView::FileListView (constructor)
//
// Constructs an overlay file list view allowing the user to select a file from the edit buffer
//
//-------------------------------------------------------------------------------------------------
FileListView::FileListView( ProgramDefaults *pd, CxEditBufferList *ebl, Project *proj, CxScreen *screenPtr )
{
    programDefaults = pd;
    editBufferList  = ebl;
    screen          = screenPtr;
    project         = proj;
    
    // setup the resize callback
    screen->addScreenSizeCallback( CxDeferCall( this, &FileListView::screenResizeCallback ));
    
    // recalc where everything should disolay
    recalcScreenPlacements();
}


//-------------------------------------------------------------------------------------------------
// FileListView::screenResizeCallback (callback)
//
// Called with the user resizes the terminal window.  Recalculates key parts of the screen.
//
//-------------------------------------------------------------------------------------------------
void
FileListView::screenResizeCallback( void )
{
    // recalculate all the component placements
    recalcScreenPlacements();
}


//-------------------------------------------------------------------------------------------------
// FileListView::recalcScreenPlacements
//
// Given a screen window size, this calculates all the rows that are important to
// to the editor.
//
//
//-------------------------------------------------------------------------------------------------
void
FileListView::recalcScreenPlacements(void)
{
    // number of lines on the screen
    screenNumberOfLines = screen->rows();

	// number of cols on the screen
    screenNumberOfCols  = screen->cols();

	// calculate where the first dash line proceeding list is on the screen
    windowFrameTop          =  5;
    windowFrameBottom       = 25;
    windowFrameLeft         = 10;
    windowFrameRight        = 80;
    
    // number of lines in the list of file
    screenFileListNumberOfLines = windowFrameBottom - windowFrameTop - 1;
     
	// calculate the first physical screen line of the list
	screenFileListFirstListLine = windowFrameTop + 1;
    
    // calculate the last physical screen line of the list
    screenFileListLastListLine  = screenFileListFirstListLine + screenFileListNumberOfLines;

	// calculate where the last frame line after the list will be displayed
    screenFileListFrameLine = windowFrameTop + screenFileListNumberOfLines + 1;
    
	// number of cols in the list of files
    screenFileListNumberOfCols = screenNumberOfCols;

	// set the first list index visible in the scrolling list
	firstVisibleListIndex = 0;
    
    // set the selected item in the list, zero by default
    selectedListItemIndex = editBufferList->currentItemIndex();
}




//-------------------------------------------------------------------------------------------------
// FileListView::redraw
//
// Moves the visible window indexes so the cursor is visible and updates the screen
//
//-------------------------------------------------------------------------------------------------
void
FileListView::redraw( void )
{
    reframe();
    
    //CxString statusBarTextColorTerminalString = programDefaults->statusBarText()->terminalString();
    //CxString statusBarTextColor
    
    
    //---------------------------------------------------------------------------------------------
    // draw the title bar
    //---------------------------------------------------------------------------------------------
    // set the status bar foreground and background colors
    screen->setForegroundColor(programDefaults->statusBarTextColor() );
    screen->setBackgroundColor(programDefaults->statusBarBackgroundColor() );
    
    CxString header = CxString("-- PROJECT: ") + project->projectName() + CxString(" ");
    while( header.length() < windowFrameRight-windowFrameLeft) header += CxString("-");
    
    screen->writeTextAt( windowFrameTop, windowFrameLeft, header, false );
    screen->resetColors();
    
    //---------------------------------------------------------------------------------------------
    // draw the window lines
    //---------------------------------------------------------------------------------------------
    // looping on visible  items
    for (int c=0; c<screenFileListNumberOfLines; c++) {
        
        // get the logical list index that is the first visible item on the screen
        int logicalItem = firstVisibleListIndex + c;
        
        CxColor resetColor;
        CxString text;
        int realTextLength = 0;
        
        CxString pointerText = "> ";
        CxString afterFileNameText = "  ";
        CxString borderText = " ";
        CxString statusBarTextColorCode = programDefaults->statusBarTextColor()->terminalString();
        CxString statusBarBackgroundColorCode = programDefaults->statusBarBackgroundColor()->terminalString();
        CxString statusBarTextColorResetCode = programDefaults->statusBarTextColor()->resetTerminalString();
        CxString statusBarBackgroundColorResetCode = programDefaults->statusBarBackgroundColor()->resetTerminalString();
        
        
        
        // if the logical Item is less than the number of items in the buffer list
        if (logicalItem < editBufferList->items()) {
            
            // get the edit buffer at that index
            CxEditBuffer *eb = editBufferList->at(logicalItem);
            
            CxString touchedText  = "";
            CxString inMemoryText = "";
            
            if (eb->isTouched()) {
                touchedText = " /modified";
            }
            
            if (eb->isInMemory()) {
                inMemoryText = " /memory";
            }

			CxString postFixText = touchedText + inMemoryText;


            // get the file assuming we haven't made a mistake
            CxString filePath = eb->getFilePath( );
            
            // debug
            filePath = filePath + CxString("  "); // + CxString( logicalItem );
        
            //-------------------------------------------------------------------------------------
            // draw a selected list item
            //-------------------------------------------------------------------------------------
            if (selectedListItemIndex == logicalItem) {
                
                text + CxString("");
                realTextLength = 0;
            
                // add left frame text
                text += statusBarTextColorCode + statusBarBackgroundColorCode;
                text += CxString(" "); realTextLength++;
                
                // add the file pointer text
                text += pointerText; realTextLength += pointerText.length();
                
                // add the file path string
                text += filePath; realTextLength += filePath.length();
                
                // add the highlight padding after the file name
                text += afterFileNameText; realTextLength += afterFileNameText.length();
                
                // pad the remaining space before the right frame
                while( realTextLength + postFixText.length() < windowFrameRight-windowFrameLeft-1)  {
                    text += CxString(" ");
                    realTextLength++;
                }

				text += postFixText; realTextLength += postFixText.length();

                
                // add the right frame
                text += statusBarTextColorCode + statusBarBackgroundColorCode;
                text += borderText; realTextLength += borderText.length();
                text += statusBarTextColorResetCode + statusBarBackgroundColorResetCode;
                 
                // write out the string
                screen->writeTextAt( screenFileListFirstListLine + c, windowFrameLeft, text, false );

            //-------------------------------------------------------------------------------------
            // draw an unselected list item
            //-------------------------------------------------------------------------------------
            } else {
                
                text + CxString("");
                realTextLength = 0;
            
                // add left frame text
                text += statusBarTextColorCode + statusBarBackgroundColorCode;
                text += CxString(" "); realTextLength++;
                text += statusBarTextColorResetCode + statusBarBackgroundColorResetCode;
                
                // add space text before filename
                text += statusBarTextColorResetCode + statusBarBackgroundColorResetCode;
                text += CxString("  "); realTextLength += 2;

                // add the file path string
                text += filePath; realTextLength += filePath.length();
                
                // add the highlight padding after the file name
                text += afterFileNameText; realTextLength += afterFileNameText.length();
                
                // pad the remaining space before the right frame
                while( realTextLength + postFixText.length() <  windowFrameRight-windowFrameLeft-1)  {
                    text += CxString(" ");
                    realTextLength++;
                }

				text += postFixText; realTextLength += postFixText.length();
                
                // add the right frame text
                text += statusBarTextColorCode + statusBarBackgroundColorCode;
                text += borderText; realTextLength += borderText.length();
                text += statusBarTextColorResetCode + statusBarBackgroundColorResetCode;
                                
                screen->writeTextAt( screenFileListFirstListLine + c, windowFrameLeft, text, false );
                
            }
            
        //-----------------------------------------------------------------------------------------
        // draw list items beyond the the list if the window is larger than the list
        //-----------------------------------------------------------------------------------------
        } else {
            
            text + CxString("");
            realTextLength = 0;
        
            // add left frame text
            text += statusBarTextColorCode + statusBarBackgroundColorCode;
            text += CxString(" "); realTextLength++;
            text += statusBarTextColorResetCode + statusBarBackgroundColorResetCode;
            
            // pad the remaining space before the right frame
            while( realTextLength <  windowFrameRight-windowFrameLeft-1)  {
                text += CxString(" ");
                realTextLength++;
            }
            
            // add the right frame text
            text += statusBarTextColorCode + statusBarBackgroundColorCode;
            text += borderText; realTextLength += borderText.length();
            text += statusBarTextColorResetCode + statusBarBackgroundColorResetCode;
                            
            screen->writeTextAt( screenFileListFirstListLine + c, windowFrameLeft, text, false );
        }
        
    }
        
    //---------------------------------------------------------------------------------------------
    // draw the bottom frame
    //---------------------------------------------------------------------------------------------
    // set the status bar foreground and background colors
    screen->setForegroundColor(programDefaults->statusBarTextColor() );
    screen->setBackgroundColor(programDefaults->statusBarBackgroundColor() );
    
    CxString footer = "";
    while( footer.length() < windowFrameRight-windowFrameLeft) footer += CxString(" ");

    screen->writeTextAt( windowFrameBottom, windowFrameLeft, footer, false );

    screen->resetColors();
    screen->flush();
}

/*
CxString
FileListView::buildWindowLine( CxString text, int prompt )
{    
    if (prompt) {
        text = CxString("> ") + filePath + CxString(" ");
    } 
    
    while( text.length() < windowFrameRight-windowFrameLeft-2) text += CxString(" ");

    
 
    return( text );
}

CxString
FileListView::encapsolateWithEntryExitText( CxString line, CxString entryString, CxString exitString )
{
    return( entryString + line + exitString );
}
*/


//-------------------------------------------------------------------------------------------------
// FileListView::getSelectedItem
//
// return the path of the currently selected item
//
//-------------------------------------------------------------------------------------------------
CxString
FileListView::getSelectedItem( void )
{
    // get the edit buffer at that index
    CxEditBuffer *eb = editBufferList->at( selectedListItemIndex );
    
    // get the file assuming we haven't made a mistake
    CxString filePath = eb->getFilePath( );
    
    // return the name of the path
    return(filePath);
}


//-------------------------------------------------------------------------------------------------
// FileListView::routeKeyAction
//	
// Keys passed into routeKeyAction are targeted for the edit view changing the text buffer
// and then the screen is updated to reflect.
//
//-------------------------------------------------------------------------------------------------
void
FileListView::routeKeyAction( CxKeyAction keyAction )
{
	//---------------------------------------------------------------------------------------------
	// based on the kind of key
	//
	//---------------------------------------------------------------------------------------------
	switch (keyAction.actionType() )
	{
		//-----------------------------------------------------------------------------------------
		// select another file in the list
		//
		//-----------------------------------------------------------------------------------------
		case CxKeyAction::CURSOR:
			{
                if (handleArrows( keyAction )) {
                    redraw();
                }
                
                screen->flush();
			}
			break;

        //-----------------------------------------------------------------------------------------
        // ignore everything else
        //-----------------------------------------------------------------------------------------
      	default:
        	break;
	}

    return;
}

 

//-------------------------------------------------------------------------------------------------
// FileListView::selectedItemVisible
//
// if selected item isn't visible move the text in the visible window
//
//-------------------------------------------------------------------------------------------------

int
FileListView::reframe( )
{
    int changeMade = false;
    
    while ( selectedListItemIndex < firstVisibleListIndex ) {
        changeMade = true;
        firstVisibleListIndex--;
    }
    
    while (selectedListItemIndex >= firstVisibleListIndex + screenFileListNumberOfLines) {
        changeMade = true;
        firstVisibleListIndex++;
    }
    
    if (changeMade) return(true);
    
    return(false);
    
}

//-------------------------------------------------------------------------------------------------
// FileListView::handleArrows
//
// moves the cursor according to the desired direction and what is valid in the
// edit buffer
//
//-------------------------------------------------------------------------------------------------
int
FileListView::handleArrows( CxKeyAction keyAction )
{
    if (keyAction.tag() == "<arrow-down>") {
        
        selectedListItemIndex++;
        
        if (selectedListItemIndex >= editBufferList->items()) {
            selectedListItemIndex--;
        }
        
        
        return( true );

    }

    if (keyAction.tag() == "<arrow-up>") {
        
        selectedListItemIndex--;
        
        if (selectedListItemIndex < 0) {
            selectedListItemIndex = 0;
        }
        
        
        return( true );
    }

    return(false);
}
